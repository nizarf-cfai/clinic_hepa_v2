<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedForce AI - Clinical Dashboard</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: grid; grid-template-columns: 400px 1fr; height: 100vh; }
        
        /* Left Panel: Simulation Control */
        .sidebar { background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 20px; }
        .log-container { flex-grow: 1; overflow-y: auto; background: #0f172a; color: #f8fafc; padding: 15px; border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 12px; margin-top: 15px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #1e293b; padding-bottom: 5px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .online { background: #dcfce7; color: #166534; }
        .offline { background: #fee2e2; color: #991b1b; }

        /* Main Panel: AI Intelligence */
        .main { padding: 30px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        h2 { margin-top: 0; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        pre { background: #f1f5f9; padding: 15px; border-radius: 8px; font-size: 13px; overflow-x: auto; border: 1px solid #cbd5e1; }
        .question-card { border-left: 4px solid var(--primary); background: #eff6ff; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .btn-start { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
        .btn-start:disabled { background: #94a3b8; }
    </style>
</head>
<body>

    <!-- SIDEBAR: SIMULATION CONTROL -->
    <div class="sidebar">
        <h2>üè• Simulation</h2>
        <button id="start-btn" class="btn-start">Start Clinical Session</button>
        
        <div style="margin-top:20px">
            <div>Simulation: <span id="sim-status" class="status-badge offline">OFFLINE</span></div>
            <div style="margin-top:8px">Transcriber: <span id="trans-status" class="status-badge offline">OFFLINE</span></div>
        </div>

        <div class="log-container" id="log-content">
            <div style="color: #64748b">System ready. Waiting for start...</div>
        </div>
    </div>

    <!-- MAIN: AI ANALYTICS -->
    <div class="main">
        <h1 style="margin-top:0">Clinical Intelligence Dashboard</h1>
        
        <div class="grid">
            <!-- Diagnosis View -->
            <div class="card">
                <h2>ü©∫ Live Diagnosis Consolidation</h2>
                <pre id="diagnosis-json">Waiting for AI processing...</pre>
            </div>

            <!-- Question View -->
            <div class="card">
                <h2>‚ùì Recommended Questions</h2>
                <div id="question-list">
                    <p style="color: #64748b">Questions will be ranked here as the interview progresses.</p>
                </div>
            </div>
        </div>

        <!-- Supervisor Status -->
        <div class="card" style="margin-top:20px; border-top: 4px solid #f59e0b;">
            <h2>üö® Interview Supervisor Status</h2>
            <div id="supervisor-status">Interview in progress. Assessing data sufficiency...</div>
        </div>
    </div>

    <script>
        const simStatus = document.getElementById('sim-status');
        const transStatus = document.getElementById('trans-status');
        const logContent = document.getElementById('log-content');
        const startBtn = document.getElementById('start-btn');
        const diagPre = document.getElementById('diagnosis-json');
        const qList = document.getElementById('question-list');
        const superStatus = document.getElementById('supervisor-status');

        let simSocket, transSocket;
        let audioCtx;
        let nextStartTime = 0;
        const SAMPLE_RATE = 24000;

        // Initialize Web Audio for local playback
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            nextStartTime = audioCtx.currentTime;
        }

        function playInt16(buffer) {
            if (!audioCtx) return;
            const int16 = new Int16Array(buffer);
            const float32 = new Float32Array(int16.length);
            for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 32768;

            const audioBuf = audioCtx.createBuffer(1, float32.length, SAMPLE_RATE);
            audioBuf.getChannelData(0).set(float32);
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuf;
            source.connect(audioCtx.destination);
            
            const start = Math.max(nextStartTime, audioCtx.currentTime);
            source.start(start);
            nextStartTime = start + audioBuf.duration;
        }

        startBtn.onclick = () => {
            initAudio();
            startBtn.disabled = true;
            startBtn.innerText = "Session Active";

            // 1. Connect to Transcriber
            transSocket = new WebSocket('ws://127.0.0.1:8000/ws/transcriber');
            transSocket.binaryType = 'arraybuffer';

            transSocket.onopen = () => {
                transStatus.innerText = "ONLINE";
                transStatus.className = "status-badge online";
                transSocket.send(JSON.stringify({ type: 'start', patient_id: 'P0001' }));
                
                // 2. Connect to Simulation
                startSimulation();
            };

            transSocket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'ai_update') handleAIUpdate(data);
            };
        };

        function startSimulation() {
            simSocket = new WebSocket('ws://127.0.0.1:8000/ws/simulation');
            
            simSocket.onopen = () => {
                simStatus.innerText = "ONLINE";
                simStatus.className = "status-badge online";
                simSocket.send(JSON.stringify({ type: 'start', patient_id: 'P0001', gender: 'Male' }));
            };

            simSocket.onmessage = async (e) => {
                // Audio Data (Binary)
                if (e.data instanceof ArrayBuffer || e.data instanceof Blob) {
                    const buf = e.data instanceof Blob ? await e.data.arrayBuffer() : e.data;
                    playInt16(buf); // Play in speakers
                    if (transSocket.readyState === 1) transSocket.send(buf); // Pipe to AI
                    return;
                }

                // JSON Messages
                const data = JSON.parse(e.data);
                
                // If audio is base64 inside JSON
                if (data.type === 'audio' && data.data) {
                    const binary = Uint8Array.from(atob(data.data), c => c.charCodeAt(0)).buffer;
                    playInt16(binary);
                    if (transSocket.readyState === 1) transSocket.send(binary);
                    return;
                }

                // Log other events
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `<span style="color:#38bdf8">[${data.type}]</span> ${data.message || data.data || ''}`;
                logContent.prepend(div);
            };
        }

        function handleAIUpdate(data) {
            // Update Diagnosis Pre
            diagPre.innerText = JSON.stringify(data.consolidated, null, 2);

            // Update Questions
            qList.innerHTML = '';
            data.ranked_questions.slice(0, 5).forEach(q => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.innerHTML = `<strong>Priority:</strong> ${q.content}`;
                qList.appendChild(div);
            });

            // Update Supervisor
            if (data.is_finished) {
                superStatus.innerHTML = "<b style='color:#166534'>‚úÖ COMPLETE:</b> Sufficient clinical data gathered for the doctor.";
                superStatus.parentElement.style.borderTopColor = "#166534";
            }
        }
    </script>
</body>
</html>