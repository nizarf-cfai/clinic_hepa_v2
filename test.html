<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MedForce - Audio Test Only</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .audio-bar { transition: height 0.1s ease; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen flex flex-col items-center justify-center p-6">

    <div class="max-w-md w-full bg-gray-900 rounded-3xl p-8 border border-gray-800 shadow-2xl">
        <h1 class="text-2xl font-bold text-center mb-2">Audio Stream Test</h1>
        <p class="text-gray-500 text-center text-sm mb-8">Target: /ws/simulation</p>

        <!-- Status & Visualizer -->
        <div class="flex flex-col items-center space-y-6">
            <div id="status" class="px-4 py-1 rounded-full bg-red-900/30 text-red-500 text-xs font-bold border border-red-500/50">
                DISCONNECTED
            </div>

            <!-- Simple Visualizer -->
            <div class="flex items-end justify-center space-x-1 h-12">
                <div id="bar1" class="audio-bar w-2 bg-blue-500 h-2 rounded-full"></div>
                <div id="bar2" class="audio-bar w-2 bg-blue-400 h-4 rounded-full"></div>
                <div id="bar3" class="audio-bar w-2 bg-blue-500 h-2 rounded-full"></div>
                <div id="bar4" class="audio-bar w-2 bg-blue-600 h-6 rounded-full"></div>
            </div>

            <div class="text-center">
                <div id="byteCounter" class="text-3xl font-mono font-bold text-blue-400">0</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">Bytes Received</div>
            </div>

            <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold text-lg transition-all active:scale-95">
                Connect & Play
            </button>
        </div>

        <!-- Debug Log -->
        <div id="debugLog" class="mt-8 bg-black/50 rounded-xl p-4 h-32 overflow-y-auto font-mono text-[10px] text-gray-400 border border-gray-800">
            <div>- System Ready -</div>
        </div>
    </div>

    <script>
        let socket;
        let audioCtx;
        let nextStartTime = 0;
        let bytesTotal = 0;
        const SAMPLE_RATE = 24000;

        const startBtn = document.getElementById('startBtn');
        const debugLog = document.getElementById('debugLog');
        const byteCounter = document.getElementById('byteCounter');
        const status = document.getElementById('status');

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        // --- Decode Base64 to ArrayBuffer ---
        function base64ToBuffer(base64) {
            const bin = window.atob(base64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) {
                bytes[i] = bin.charCodeAt(i);
            }
            return bytes.buffer;
        }

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            log("Audio Context: " + audioCtx.state);
        }

        function playChunk(buffer) {
            // 1. PCM16 to Float32
            const int16 = new Int16Array(buffer);
            const float32 = new Float32Array(int16.length);
            for (let i = 0; i < int16.length; i++) {
                float32[i] = int16[i] / 32768.0;
            }

            // 2. Create and Schedule Buffer
            const audioBuffer = audioCtx.createBuffer(1, float32.length, SAMPLE_RATE);
            audioBuffer.getChannelData(0).set(float32);

            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            if (nextStartTime < now) nextStartTime = now + 0.05;
            source.start(nextStartTime);
            nextStartTime += audioBuffer.duration;

            // 3. UI Feedback
            bytesTotal += buffer.byteLength;
            byteCounter.innerText = bytesTotal.toLocaleString();
            animateBars();
        }

        function animateBars() {
            for(let i=1; i<=4; i++) {
                document.getElementById('bar'+i).style.height = Math.random() * 40 + 10 + 'px';
            }
            setTimeout(() => {
                for(let i=1; i<=4; i++) document.getElementById('bar'+i).style.height = '8px';
            }, 100);
        }

        startBtn.onclick = async () => {
            await initAudio();
            startBtn.disabled = true;
            startBtn.innerText = "Connecting...";

            socket = new WebSocket('ws://localhost:8000/ws/simulation');

            socket.onopen = () => {
                status.innerText = "CONNECTED";
                status.className = "px-4 py-1 rounded-full bg-green-900/30 text-green-500 text-xs font-bold border border-green-500/50";
                log("WS Connected. Sending Start...");
                socket.send(JSON.stringify({ "type": "start", "patient_id": "P0001", "gender": "Male" }));
            };

            socket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    
                    if (msg.type === 'audio' && msg.data) {
                        const buffer = base64ToBuffer(msg.data);
                        playChunk(buffer);
                    } else if (msg.type === 'turn') {
                        log("Turn: " + msg.data);
                    } else {
                        log("Msg Type: " + msg.type);
                    }
                } catch (e) {
                    log("Error parsing JSON");
                }
            };

            socket.onclose = () => {
                status.innerText = "DISCONNECTED";
                status.className = "px-4 py-1 rounded-full bg-red-900/30 text-red-500 text-xs font-bold border border-red-500/50";
                log("WS Closed");
                startBtn.disabled = false;
                startBtn.innerText = "Connect & Play";
            };

            socket.onerror = (err) => log("WS Error Detected");
        }
    </script>
</body>
</html>